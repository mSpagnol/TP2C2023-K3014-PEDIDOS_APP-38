
USE GD1C2023
GO


/* DROP FK */
IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_TIEMPO' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_TIEMPO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_CATEGORIA_LOCAL' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_CATEGORIA_LOCAL
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_LOCALIDAD' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_LOCALIDAD
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_ID_DIA' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_ID_DIA
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_DIA_ID' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_DIA_ID
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_HORARIO' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_HORARIO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_RANGO_HORARIO' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_RANGO_HORARIO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_LOCAL_NOMBRE' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_LOCAL_NOMBRE
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_RANGO_ETARIO_USUARIO' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_RANGO_ETARIO_USUARIO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_RANGO_ETARIO_REPARTIDOR' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_RANGO_ETARIO_REPARTIDOR
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_ESTADO' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_ESTADO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PEDIDO_TIPO_MOVILIDAD' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO DROP CONSTRAINT FK_PEDIDO_TIPO_MOVILIDAD
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_ENVIO_TIEMPO' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA DROP CONSTRAINT FK_ENVIO_TIEMPO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_ENVIO_LOCALIDAD' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA DROP CONSTRAINT FK_ENVIO_LOCALIDAD
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_ENVIO_ID_DIA' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA DROP CONSTRAINT FK_ENVIO_ID_DIA
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_ENVIO_HORARIO' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA DROP CONSTRAINT FK_ENVIO_HORARIO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_ENVIO_RANGO_ETARIO_USUARIO' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA DROP CONSTRAINT FK_ENVIO_RANGO_ETARIO_USUARIO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_ENVIO_RANGO_ETARIO_REPARTIDOR' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA DROP CONSTRAINT FK_ENVIO_RANGO_ETARIO_REPARTIDOR
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_ENVIO_ESTADO' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA DROP CONSTRAINT FK_ENVIO_ESTADO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_PAQUETE_NRO' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA DROP CONSTRAINT FK_PAQUETE_NRO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_ENVIO_ID_IDA' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA DROP CONSTRAINT FK_ENVIO_ID_IDA

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_ENVIO_TIPO_MOVILIDAD' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA DROP CONSTRAINT FK_ENVIO_TIPO_MOVILIDAD
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_RECLAMO_RANGO_ETARIO_OPERADOR' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO DROP CONSTRAINT FK_RECLAMO_RANGO_ETARIO_OPERADOR
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_RECLAMO_LOCALIDAD' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO DROP CONSTRAINT FK_RECLAMO_LOCALIDAD

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_RECLAMO_ID_DIA' , 'F') IS NOT NULL
    ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO DROP CONSTRAINT FK_RECLAMO_ID_DIA

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_RECLAMO_TIEMPO' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO DROP CONSTRAINT FK_RECLAMO_TIEMPO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_RECLAMO_HORARIO' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO DROP CONSTRAINT FK_RECLAMO_HORARIO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FK_RECLAMO_ESTADO' , 'F') IS NOT NULL
	ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO DROP CONSTRAINT FK_RECLAMO_ESTADO
GO

/* DROP TABLES */

IF OBJECT_ID('BI_PEDIDOS_APP.BI_TIEMPO', 'U') IS NOT NULL
    DROP TABLE BI_PEDIDOS_APP.BI_TIEMPO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_DIA', 'U') IS NOT NULL
    DROP TABLE BI_PEDIDOS_APP.BI_DIA
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_RANGO_HORARIO', 'U') IS NOT NULL
    DROP TABLE BI_PEDIDOS_APP.BI_RANGO_HORARIO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_PROVINCIA', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_PROVINCIA
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_LOCALIDAD', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_LOCALIDAD
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_RANGO_ETARIO', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_RANGO_ETARIO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_TIPO_MEDIO_DE_PAGO', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_TIPO_MEDIO_DE_PAGO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_LOCAL', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_LOCAL
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_LOCAL_TIPO', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_LOCAL_TIPO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_LOCAL_CATEGORIA', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_LOCAL_CATEGORIA
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_TIPO_MOVILIDAD', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_TIPO_MOVILIDAD
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_TIPO_PAQUETE', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_TIPO_PAQUETE
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_DIRECCION', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_DIRECCION
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_ESTADO_RECLAMO', 'U') IS NOT NULL
    DROP TABLE BI_PEDIDOS_APP.BI_ESTADO_RECLAMO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_ESTADO_PEDIDO', 'U') IS NOT NULL
    DROP TABLE BI_PEDIDOS_APP.BI_ESTADO_PEDIDO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_ESTADO_ENVIO_MENSAJERIA', 'U') IS NOT NULL
    DROP TABLE BI_PEDIDOS_APP.BI_ESTADO_ENVIO_MENSAJERIA
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_ESTADO_PEDIDOS', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_ESTADO_PEDIDOS
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_ESTADO_ENVIO_MENSAJERIA', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_ESTADO_ENVIO_MENSAJERIA
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_HECHO_PEDIDO', 'U') IS NOT NULL
	DROP TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_HECHO_RECLAMO', 'U') IS NOT NULL
    DROP TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA', 'U') IS NOT NULL
    DROP TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA
GO

IF OBJECT_ID('BI_PEDIDOS_APP.BI_PAQUETE', 'U') IS NOT NULL
    DROP TABLE BI_PEDIDOS_APP.BI_PAQUETE
GO

/* DROP PROCEDURES */

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_TIEMPO') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_TIEMPO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.MIGRAR_BI_DIA') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_DIA
GO

IF OBJECT_ID('BI_PEDIDOS_APP.MIGRAR_BI_RANGO_HORARIO') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_RANGO_HORARIO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_PROVINCIA') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_PROVINCIA
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_LOCALIDAD') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_LOCALIDAD
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_RANGO_ETARIO') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_RANGO_ETARIO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_TIPO_MEDIO_DE_PAGO') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_TIPO_MEDIO_DE_PAGO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_LOCAL') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_LOCAL
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_TIPO_LOCAL') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_TIPO_LOCAL
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_CATEGORIA_LOCAL') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_CATEGORIA_LOCAL
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_TIPO_MOVILIDAD') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_TIPO_MOVILIDAD
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_TIPO_PAQUETE') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_TIPO_PAQUETE
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_PEDIDOS') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_PEDIDOS
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_ENVIO_MENSAJERIA') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_ENVIO_MENSAJERIA
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_RECLAMO') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_RECLAMO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_HECHO_PEDIDO') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_HECHO_PEDIDO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_HECHO_ENVIO_MENSAJERIA') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_HECHO_ENVIO_MENSAJERIA
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.MIGRAR_BI_HECHO_RECLAMO') IS NOT NULL
	DROP PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_HECHO_RECLAMO
GO

/*DROP FUNCTIONS*/

IF OBJECT_ID ('BI_PEDIDOS_APP.FX_CALCULAR_RANGO_HORARIO') IS NOT NULL
	DROP FUNCTION BI_PEDIDOS_APP.FX_CALCULAR_RANGO_HORARIO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_USUARIO') IS NOT NULL
	DROP FUNCTION BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_USUARIO
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_REPARTIDOR') IS NOT NULL
	DROP FUNCTION BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_REPARTIDOR
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_OPERADOR') IS NOT NULL
	DROP FUNCTION BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_OPERADOR
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.FX_CALCULAR_ESTADO') IS NOT NULL
	DROP FUNCTION BI_PEDIDOS_APP.FX_CALCULAR_ESTADO
GO

-- DROP VIEWS
IF OBJECT_ID('BI_PEDIDOS_APP.VISTA_CANTIDAD_PEDIDOS_MES_ANIO_SEGUN_LOCALIDAD ', 'V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_CANTIDAD_PEDIDOS_MES_ANIO_SEGUN_LOCALIDAD
GO

IF OBJECT_ID('BI_PEDIDOS_APP.VISTA_MONTO_TOTAL_NO_COBRADO', 'V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_MONTO_TOTAL_NO_COBRADO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.VISTA_MONTO_ENVIO_PROMEDIO_MENSUAL','V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_MONTO_ENVIO_PROMEDIO_MENSUAL
GO

IF OBJECT_ID('BI_PEDIDOS_APP.VISTA_DESVIO_PROMEDIO_DE_ENTREGA','V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_DESVIO_PROMEDIO_DE_ENTREGA
GO

IF OBJECT_ID('BI_PEDIDOS_APP.VISTA_MONTO_CUPONES_POR_RANGO_ETARIO_USUARIO','V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_MONTO_CUPONES_POR_RANGO_ETARIO_USUARIO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.VISTA_PROMEDIO_CALIFICACION_MENSUAL','V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_PROMEDIO_CALIFICACION_MENSUAL
GO


IF OBJECT_ID('BI_PEDIDOS_APP.VISTA_PORCETAJE_PEDIDOS_Y_ENVIOS_MENSUALES_POR_LOCALIDAD','V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_PORCETAJE_PEDIDOS_Y_ENVIOS_MENSUALES_POR_LOCALIDAD
GO

IF OBJECT_ID('BI_PEDIDOS_APP.VISTA_PROMEDIO_MENSUAL_VALOR_ASEGURADO','V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_PROMEDIO_MENSUAL_VALOR_ASEGURADO
GO

IF OBJECT_ID('BI_PEDIDOS_APP.VISTA_PROMEDIO_MENSUAL_RECLAMOS_POR_LOCAL','V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_PROMEDIO_MENSUAL_RECLAMOS_POR_LOCAL
GO

IF OBJECT_ID ('BI_PEDIDOS_APP.VISTA_TIEMPO_PROMEDIO_RECLAMOS_MENSUAL', 'V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_TIEMPO_PROMEDIO_RECLAMOS_MENSUAL
GO

IF OBJECT_ID('BI_PEDIDOS_APP.VISTA_MONTO_MENSUAL_A_PARTIR_DE_CUPONES_RECLAMO', 'V') IS NOT NULL
	DROP VIEW BI_PEDIDOS_APP.VISTA_MONTO_MENSUAL_A_PARTIR_DE_CUPONES_RECLAMO
GO

/* DROP SCHEMA */
IF EXISTS (SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME = 'BI_PEDIDOS_APP')
	DROP SCHEMA BI_PEDIDOS_APP
GO

/* CREANDO SCHEMA */
CREATE SCHEMA BI_PEDIDOS_APP
GO

/*CREATE TABLES*/

CREATE TABLE BI_PEDIDOS_APP.BI_TIEMPO(
    ID_TIEMPO INT IDENTITY(1,1) PRIMARY KEY,
    TIEMPO_ANIO INT,
    TIEMPO_MES INT,
);
GO

CREATE TABLE BI_PEDIDOS_APP.BI_DIA(
    ID_DIA nvarchar(20) PRIMARY KEY,
    DIA_LETRA NVARCHAR(2)
);
GO

CREATE TABLE BI_PEDIDOS_APP.BI_RANGO_HORARIO(
    ID_RANGO_HORARIO INT IDENTITY(1,1) PRIMARY KEY,
    RANGO_HORARIO_DESCRIPCION nvarchar(255)
);
GO

CREATE TABLE BI_PEDIDOS_APP.BI_PROVINCIA(
	PROVINCIA_ID INT IDENTITY(1,1) PRIMARY KEY,
	PROVINCIA_NOMBRE nvarchar(255) 
);
GO

CREATE TABLE BI_PEDIDOS_APP.BI_LOCALIDAD(
	LOCALIDAD_ID INT PRIMARY KEY,
	LOCALIDAD_NOMBRE nvarchar(255)
);
GO

CREATE TABLE BI_PEDIDOS_APP.BI_RANGO_ETARIO(
	RANGO_ETARIO_ID INT IDENTITY(1,1) PRIMARY KEY,
	RANGO_ETARIO_DESCRIPCION nvarchar(255)
);
GO

CREATE TABLE BI_PEDIDOS_APP.BI_TIPO_MEDIO_DE_PAGO(
	TIPO_MEDIO_DE_PAGO_ID INT IDENTITY(1,1) PRIMARY KEY,
	TIPO_MEDIO_DE_PAGO nvarchar(50),
);
GO

CREATE TABLE BI_PEDIDOS_APP.BI_LOCAL(
	LOCAL_NOMBRE nvarchar(100) PRIMARY KEY,
	LOCAL_DESCRIPCION nvarchar(255) ,
);
GO


CREATE TABLE BI_PEDIDOS_APP.BI_LOCAL_TIPO(
	LOCAL_TIPO_ID INT IDENTITY(1,1) PRIMARY KEY,
	LOCAL_TIPO_DESCRIPCION nvarchar(50)
);
GO

CREATE TABLE BI_PEDIDOS_APP.BI_LOCAL_CATEGORIA(
	LOCAL_CATEGORIA_ID INT IDENTITY(1,1) PRIMARY KEY,
	LOCAL_CATEGORIA nvarchar(50)
);
GO

/*
CREATE TABLE BI_PEDIDOS_APP.BI_DIRECCION(
	DIRECCION_COD INT IDENTITY PRIMARY KEY,
	LOCAL_NOMBRE nvarchar(100),
	LOCAL_DIRECCION nvarchar(255),
	LOCALIDAD_COD INT
);*/

CREATE TABLE BI_PEDIDOS_APP.BI_TIPO_MOVILIDAD(
	TIPO_MOVILIDAD_ID INT PRIMARY KEY,
	TIPO_MOVILIDAD_VEHICULO nvarchar(50),
);



CREATE TABLE BI_PEDIDOS_APP.BI_TIPO_PAQUETE(
	PAQUETE_ID INT IDENTITY (1,1) PRIMARY KEY,
	PAQUETE_TIPO nvarchar(50),
	PAQUETE_TIPO_PRECIO nvarchar(50),
	);


CREATE TABLE BI_PEDIDOS_APP.BI_ESTADO_PEDIDO(
    ESTADO_PEDIDO_ID INT IDENTITY (1,1) PRIMARY KEY,
    PEDIDO_ESTADO nvarchar(255)
);
GO

CREATE TABLE BI_PEDIDOS_APP.BI_ESTADO_ENVIO_MENSAJERIA(
    ESTADO_ENVIO_MENSAJERIA_ID INT IDENTITY (1,1) PRIMARY KEY,
    ENVIO_MENSAJERIA_ESTADO nvarchar(255)
);
GO


CREATE TABLE BI_PEDIDOS_APP.BI_ESTADO_RECLAMO(
	ESTADO_RECLAMO_ID INT IDENTITY(1,1) PRIMARY KEY,
	RECLAMO_ESTADO nvarchar(255)
);
GO


CREATE TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO(
	ID_HECHO_PEDIDO INT IDENTITY (1,1) PRIMARY KEY,
	PEDIDO_TOTAL_CUPONES decimal(18,2),
	PEDIDO_TOTAL_SERVICIO decimal(18,2),
	PEDIDO_TIEMPO_ESTIMADO_ENTREGA decimal(18,2),
	PEDIDO_CALIFICACION decimal (18,0),
	LOCAL_NOMBRE nvarchar(100),
	RANGO_ETARIO_USUARIO INT,
	RANGO_ETARIO_REPARTIDOR INT,
	PEDIDO_ESTADO INT,
	ID_DIA nvarchar(20), 
	ID_RANGO_HORARIO INT,
	LOCALIDAD_ID INT,
	CATEGORIA_LOCAL INT,
	TIPO_LOCAL INT,
	ID_TIEMPO INT,
	PEDIDO_FECHA datetime2(3),
	PEDIDO_FECHA_ENTREGA datetime2(3),
	VALOR_ENVIO decimal(18,2),
	TIPO_MOVILIDAD_ID INT
);
GO


CREATE TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA(
  	ID_HECHO_ENVIO_MENSAJERIA INT IDENTITY (1,1) PRIMARY KEY,
	LOCALIDAD_ID INT,
	ENVIO_MENSAJERIA_VALOR_ASEGURADO decimal(18,2),
	ENVIO_MENSAJERIA_PRECIO_SEGURO decimal(18,2),
	ENVIO_MENSAJERIA_FECHA datetime,
	ENVIO_MENSAJERIA_ENTREGA datetime,
	ENVIO_MENSAJERIA_TIEMPO_ESTIMADO decimal(18,2),
	ID_DIA nvarchar(20),
	ID_RANGO_HORARIO INT, 
	ID_TIEMPO INT,
	ID_ESTADO_MENSAJERIA INT, 
	RANGO_ETARIO_USUARIO INT, 
	RANGO_ETARIO_REPARTIDOR INT, 
	PAQUETE_NRO INT,
	TIPO_MOVILIDAD_ID INT
);
GO

CREATE TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO(
	NRO_RECLAMO INT PRIMARY KEY, 
    RECLAMO_MONTO_CUPON_ASOCIADO decimal(18,0),
	RECLAMO_FECHA datetime2(3),
	RECLAMO_FECHA_SOLUCION datetime2(3),
	ESTADO_RECLAMO INT,
	RANGO_ETARIO_OPERADOR_ID INT,
	RANGO_HORARIO_ID INT,
	ID_TIEMPO INT,
	ID_DIA nvarchar(20),
	TIPO_RECLAMO nvarchar(50)
);
GO

--FK
ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO ADD CONSTRAINT FK_PEDIDO_ID_DIA FOREIGN KEY (ID_DIA) REFERENCES BI_PEDIDOS_APP.BI_DIA(ID_DIA)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO ADD CONSTRAINT FK_PEDIDO_HORARIO FOREIGN KEY (ID_RANGO_HORARIO) REFERENCES BI_PEDIDOS_APP.BI_RANGO_HORARIO(ID_RANGO_HORARIO)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO ADD CONSTRAINT FK_PEDIDO_LOCALIDAD FOREIGN KEY (LOCALIDAD_ID) REFERENCES BI_PEDIDOS_APP.BI_LOCALIDAD(LOCALIDAD_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO ADD CONSTRAINT FK_PEDIDO_TIEMPO FOREIGN KEY (ID_TIEMPO) REFERENCES BI_PEDIDOS_APP.BI_TIEMPO(ID_TIEMPO)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO ADD CONSTRAINT FK_PEDIDO_CATEGORIA_LOCAL FOREIGN KEY (CATEGORIA_LOCAL) REFERENCES BI_PEDIDOS_APP.BI_LOCAL_CATEGORIA(LOCAL_CATEGORIA_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO ADD CONSTRAINT FK_PEDIDO_LOCAL_NOMBRE FOREIGN KEY (LOCAL_NOMBRE) REFERENCES BI_PEDIDOS_APP.BI_LOCAL(LOCAL_NOMBRE)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO ADD CONSTRAINT FK_PEDIDO_RANGO_ETARIO_USUARIO FOREIGN KEY (RANGO_ETARIO_USUARIO) REFERENCES BI_PEDIDOS_APP.BI_RANGO_ETARIO(RANGO_ETARIO_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO ADD CONSTRAINT FK_PEDIDO_RANGO_ETARIO_REPARTIDOR FOREIGN KEY (RANGO_ETARIO_REPARTIDOR) REFERENCES BI_PEDIDOS_APP.BI_RANGO_ETARIO(RANGO_ETARIO_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO ADD CONSTRAINT FK_PEDIDO_ESTADO FOREIGN KEY (PEDIDO_ESTADO) REFERENCES BI_PEDIDOS_APP.BI_ESTADO_PEDIDO(ESTADO_PEDIDO_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_PEDIDO ADD CONSTRAINT FK_PEDIDO_TIPO_MOVILIDAD FOREIGN KEY (TIPO_MOVILIDAD_ID) REFERENCES BI_PEDIDOS_APP.BI_TIPO_MOVILIDAD(TIPO_MOVILIDAD_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA ADD CONSTRAINT FK_ENVIO_HORARIO FOREIGN KEY (ID_RANGO_HORARIO) REFERENCES BI_PEDIDOS_APP.BI_RANGO_HORARIO(ID_RANGO_HORARIO)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA ADD CONSTRAINT FK_ENVIO_LOCALIDAD FOREIGN KEY (LOCALIDAD_ID) REFERENCES BI_PEDIDOS_APP.BI_LOCALIDAD(LOCALIDAD_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA ADD CONSTRAINT FK_ENVIO_TIEMPO FOREIGN KEY (ID_TIEMPO) REFERENCES BI_PEDIDOS_APP.BI_TIEMPO(ID_TIEMPO)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA ADD CONSTRAINT FK_ENVIO_RANGO_ETARIO_USUARIO FOREIGN KEY (RANGO_ETARIO_USUARIO) REFERENCES BI_PEDIDOS_APP.BI_RANGO_ETARIO(RANGO_ETARIO_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA ADD CONSTRAINT FK_ENVIO_RANGO_ETARIO_REPARTIDOR FOREIGN KEY (RANGO_ETARIO_REPARTIDOR) REFERENCES BI_PEDIDOS_APP.BI_RANGO_ETARIO(RANGO_ETARIO_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA ADD CONSTRAINT FK_ENVIO_ESTADO FOREIGN KEY (ID_ESTADO_MENSAJERIA) REFERENCES BI_PEDIDOS_APP.BI_ESTADO_ENVIO_MENSAJERIA(ESTADO_ENVIO_MENSAJERIA_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA ADD CONSTRAINT FK_PAQUETE_NRO FOREIGN KEY (PAQUETE_NRO) REFERENCES BI_PEDIDOS_APP.BI_TIPO_PAQUETE(PAQUETE_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA ADD CONSTRAINT FK_ENVIO_ID_IDA FOREIGN KEY (ID_DIA) REFERENCES BI_PEDIDOS_APP.BI_DIA(ID_DIA)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA ADD CONSTRAINT FK_ENVIO_TIPO_MOVILIDAD FOREIGN KEY (TIPO_MOVILIDAD_ID) REFERENCES BI_PEDIDOS_APP.BI_TIPO_MOVILIDAD(TIPO_MOVILIDAD_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO ADD CONSTRAINT FK_RECLAMO_ESTADO FOREIGN KEY (ESTADO_RECLAMO) REFERENCES BI_PEDIDOS_APP.BI_ESTADO_RECLAMO(ESTADO_RECLAMO_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO ADD CONSTRAINT FK_RECLAMO_TIEMPO FOREIGN KEY (ID_TIEMPO) REFERENCES BI_PEDIDOS_APP.BI_TIEMPO(ID_TIEMPO)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO ADD CONSTRAINT FK_RECLAMO_ID_DIA FOREIGN KEY (ID_DIA) REFERENCES BI_PEDIDOS_APP.BI_DIA(ID_DIA)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO ADD CONSTRAINT FK_RECLAMO_RANGO_ETARIO_OPERADOR FOREIGN KEY (RANGO_ETARIO_OPERADOR_ID) REFERENCES BI_PEDIDOS_APP.BI_RANGO_ETARIO(RANGO_ETARIO_ID)
GO

ALTER TABLE BI_PEDIDOS_APP.BI_HECHO_RECLAMO ADD CONSTRAINT FK_RECLAMO_HORARIO FOREIGN KEY (RANGO_HORARIO_ID) REFERENCES BI_PEDIDOS_APP.BI_RANGO_HORARIO(ID_RANGO_HORARIO)
GO 


-- FUNCTIONS
CREATE FUNCTION BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_USUARIO(@USUARIO INT)
	RETURNS INT
BEGIN
	DECLARE @FECHA_NAC SMALLDATETIME
	DECLARE @EDAD INT
	DECLARE @ID_RANGO INT
	SET @FECHA_NAC = (SELECT USUARIO_FECHA_NAC FROM PEDIDOS_APP.USUARIO WHERE USUARIO_DNI = @USUARIO)

	SET @EDAD = YEAR(GETDATE()) -YEAR(@FECHA_NAC)

	IF @EDAD < 25
		SET @ID_RANGO = 1

	IF @EDAD BETWEEN 25 AND 35 
		SET @ID_RANGO = 2

	IF @EDAD BETWEEN 35 AND 55
		SET @ID_RANGO = 3

	IF @EDAD > 55
		SET @ID_RANGO = 4

	RETURN @ID_RANGO
	
END
GO

CREATE FUNCTION BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_OPERADOR(@OPERADOR INT)
	RETURNS INT
BEGIN
	DECLARE @FECHA_NAC SMALLDATETIME
	DECLARE @EDAD INT
	DECLARE @ID_RANGO INT
	SET @FECHA_NAC = (SELECT OPERADOR_FECHA_NAC FROM PEDIDOS_APP.OPERADOR WHERE OPERADOR_DNI = @OPERADOR)

	SET @EDAD = YEAR(GETDATE()) -YEAR(@FECHA_NAC)

	IF @EDAD < 25
		SET @ID_RANGO = 1

	IF @EDAD BETWEEN 25 AND 35 
		SET @ID_RANGO = 2

	IF @EDAD BETWEEN 35 AND 55
		SET @ID_RANGO = 3

	IF @EDAD > 55
		SET @ID_RANGO = 4

	RETURN @ID_RANGO
	
END
GO

CREATE FUNCTION BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_REPARTIDOR(@REPARTIDOR INT)
	RETURNS INT
BEGIN
	DECLARE @FECHA_NAC SMALLDATETIME
	DECLARE @EDAD INT
	DECLARE @ID_RANGO INT
	SET @FECHA_NAC = (SELECT REPARTIDOR_FECHA_NAC FROM PEDIDOS_APP.REPARTIDOR WHERE REPARTIDOR_DNI = @REPARTIDOR)

	SET @EDAD = YEAR(GETDATE()) -YEAR(@FECHA_NAC)

	IF @EDAD < 25
		SET @ID_RANGO = 1

	IF @EDAD BETWEEN 25 AND 35 
		SET @ID_RANGO = 2

	IF @EDAD BETWEEN 35 AND 55
		SET @ID_RANGO = 3

	IF @EDAD > 55
		SET @ID_RANGO = 4

	RETURN @ID_RANGO
	
END
GO


--LO PLANTEE ASI PORQUE EN G_AL_CUADRADO LO SACAN DE UNA TABLA ESPECIFICA y aca puede ser el horario de cualquier cosa
--por lo que puede ser cualquier horario, seria en cualquier caso tanto como pedido como horario local, etc en la vista cuando tendriamos que usar la funcion
-- y filtarlo asi ademas deberiamos pasarle el comando datepart a la fecha para que nos de la hora
CREATE FUNCTION BI_PEDIDOS_APP.FX_CALCULAR_RANGO_HORARIO(@HORA INT)
	RETURNS INT
BEGIN

	DECLARE @ID_RANGO INT

	IF @HORA BETWEEN 8 AND 10
		SET @ID_RANGO = 1

	IF @HORA BETWEEN 10 AND 12
		SET @ID_RANGO = 2

	IF @HORA BETWEEN 12 AND 14
		SET @ID_RANGO = 3

	IF @HORA BETWEEN 14 AND 16
		SET @ID_RANGO = 4

	IF @HORA BETWEEN 16 AND 18
		SET @ID_RANGO = 5

	IF @HORA BETWEEN 18 AND 20
		SET @ID_RANGO = 6

	IF @HORA BETWEEN 20 AND 22
		SET @ID_RANGO = 7

	IF @HORA BETWEEN 22 AND 24 -- aca capaz poner otro if que si hora es 00 pone el mismo id_rango por si queda alguno que sea con hora 0
		SET @ID_RANGO = 8

	IF @HORA = 00 -- aca capaz poner otro if que si hora es 00 pone el mismo id_rango por si queda alguno que sea con hora 0
		SET @ID_RANGO = 8

	RETURN @ID_RANGO
	
END
GO

CREATE FUNCTION BI_PEDIDOS_APP.FX_CALCULAR_ESTADO(@ESTADO NVARCHAR(50))
	RETURNS INT
BEGIN

	DECLARE @ID_RANGO INT

	IF @ESTADO = 'Estado Mensajeria Entregado'
		SET @ID_RANGO = 1

	IF @ESTADO = 'Estado Mensajeria Cancelado'
		SET @ID_RANGO = 2

	RETURN @ID_RANGO	
END
GO

--procedure
CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_TIEMPO
AS
BEGIN
INSERT INTO BI_PEDIDOS_APP.BI_TIEMPO(TIEMPO_ANIO, TIEMPO_MES)
    SELECT DISTINCT YEAR(P.PEDIDO_FECHA), MONTH(P.PEDIDO_FECHA)
    FROM PEDIDOS_APP.PEDIDO P
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_DIA
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_DIA(ID_DIA, DIA_LETRA)
		VALUES('Monday', 'L')
	INSERT INTO BI_PEDIDOS_APP.BI_DIA(ID_DIA, DIA_LETRA)
		VALUES('Tuesday', 'M')
	INSERT INTO BI_PEDIDOS_APP.BI_DIA(ID_DIA, DIA_LETRA)
		VALUES('Wednesday', 'M')
	INSERT INTO BI_PEDIDOS_APP.BI_DIA(ID_DIA, DIA_LETRA)
		VALUES('Thursday', 'J')
	INSERT INTO BI_PEDIDOS_APP.BI_DIA(ID_DIA, DIA_LETRA)
		VALUES('Friday', 'V')
	INSERT INTO BI_PEDIDOS_APP.BI_DIA(ID_DIA, DIA_LETRA)
		VALUES('Saturday', 'S')
	INSERT INTO BI_PEDIDOS_APP.BI_DIA(ID_DIA, DIA_LETRA)
		VALUES('Sunday', 'D')
END
GO


CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_RANGO_HORARIO
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
		VALUES('08:00-10:00')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
		VALUES('10:00-12:00')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
		VALUES('12:00-14:00')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
		VALUES('10:00-12:00')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
		VALUES('12:00-14:00')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
		VALUES('14:00-16:00')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
		VALUES('16:00-18:00')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
		VALUES('18:00-20:00')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
		VALUES('20:00-22:00')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_HORARIO(RANGO_HORARIO_DESCRIPCION)
		VALUES('22:00-24:00')
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_PROVINCIA
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_PROVINCIA(PROVINCIA_NOMBRE)
	SELECT DISTINCT p.PROVINCIA_NOMBRE
	FROM PEDIDOS_APP.LOCAL_PROVINCIA p
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_LOCALIDAD
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_LOCALIDAD(LOCALIDAD_ID,LOCALIDAD_NOMBRE)
	SELECT DISTINCT l.LOCALIDAD_COD,l.LOCALIDAD_NOMBRE
	FROM PEDIDOS_APP.LOCAL_LOCALIDAD l
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_RANGO_ETARIO
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_ETARIO(RANGO_ETARIO_DESCRIPCION)
		VALUES('<25')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_ETARIO(RANGO_ETARIO_DESCRIPCION)
		VALUES('25-35')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_ETARIO(RANGO_ETARIO_DESCRIPCION)
		VALUES('35-55')
	INSERT INTO BI_PEDIDOS_APP.BI_RANGO_ETARIO(RANGO_ETARIO_DESCRIPCION)
		VALUES('>55')
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_TIPO_MEDIO_DE_PAGO
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_TIPO_MEDIO_DE_PAGO(TIPO_MEDIO_DE_PAGO)
	SELECT DISTINCT mp.MEDIO_PAGO_TIPO
	FROM PEDIDOS_APP.MEDIO_PAGO mp
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_LOCAL
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_LOCAL(LOCAL_NOMBRE, LOCAL_DESCRIPCION)
	SELECT l.LOCAL_NOMBRE, l.LOCAL_DESCRIPCION
	FROM PEDIDOS_APP.LOCAL l
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_TIPO_LOCAL
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_LOCAL_TIPO(LOCAL_TIPO_DESCRIPCION)
	SELECT DISTINCT l.LOCAL_TIPO
	FROM PEDIDOS_APP.LOCAL l
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_CATEGORIA_LOCAL
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_LOCAL_CATEGORIA(LOCAL_CATEGORIA)
	SELECT DISTINCT l.LOCAL_CATEGORIA
	FROM PEDIDOS_APP.LOCAL l
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_TIPO_MOVILIDAD
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_TIPO_MOVILIDAD(TIPO_MOVILIDAD_ID, TIPO_MOVILIDAD_VEHICULO)
	SELECT DISTINCT tp.TIPO_MOVILIDAD_COD ,tp.TIPO_MOVILIDAD_VEHICULO
	FROM PEDIDOS_APP.TIPO_MOVILIDAD tp
END
GO


CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_TIPO_PAQUETE
AS
BEGIN
	INSERT INTO BI_PEDIDOS_APP.BI_TIPO_PAQUETE(PAQUETE_TIPO,PAQUETE_TIPO_PRECIO)
	SELECT DISTINCT l.PAQUETE_TIPO, l.PAQUETE_TIPO_PRECIO
	FROM PEDIDOS_APP.PAQUETE l
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_PEDIDOS
AS
BEGIN
    INSERT INTO BI_PEDIDOS_APP.BI_ESTADO_PEDIDO (PEDIDO_ESTADO)
        SELECT DISTINCT p.PEDIDO_ESTADO
        FROM PEDIDOS_APP.PEDIDO p
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_ENVIO_MENSAJERIA
AS
BEGIN
		INSERT INTO BI_PEDIDOS_APP.BI_ESTADO_ENVIO_MENSAJERIA (ENVIO_MENSAJERIA_ESTADO)
        SELECT DISTINCT e.ENVIO_MENSAJERIA_ESTADO
        FROM PEDIDOS_APP.ENVIO_MENSAJERIA e
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_RECLAMO
AS
BEGIN
    INSERT INTO BI_PEDIDOS_APP.BI_ESTADO_RECLAMO (RECLAMO_ESTADO)
        SELECT DISTINCT r.RECLAMO_ESTADO
        FROM PEDIDOS_APP.RECLAMO r
END
GO


CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_HECHO_PEDIDO
AS
BEGIN
    INSERT INTO BI_PEDIDOS_APP.BI_HECHO_PEDIDO(PEDIDO_TOTAL_CUPONES,
	PEDIDO_TOTAL_SERVICIO ,
	PEDIDO_TIEMPO_ESTIMADO_ENTREGA,
	LOCAL_NOMBRE,
	RANGO_ETARIO_USUARIO,
	RANGO_ETARIO_REPARTIDOR,
	PEDIDO_ESTADO,
	ID_DIA , 
	ID_RANGO_HORARIO,
	LOCALIDAD_ID,
	CATEGORIA_LOCAL,
	ID_TIEMPO,
	PEDIDO_FECHA,
	PEDIDO_FECHA_ENTREGA,
	VALOR_ENVIO,
	TIPO_MOVILIDAD_ID,
	PEDIDO_CALIFICACION)
        SELECT 
		p.PEDIDO_TOTAL_CUPONES AS PEDIDO_TOTAL_CUPONES,
		p.PEDIDO_TOTAL_SERVICIO AS PEDIDO_TOTAL_CUPONES,
		p.PEDIDO_TIEMPO_ESTIMADO_ENTREGA AS PEDIDO_TIEMPO_ESTIMADO_ENTREGA,
		p.LOCAL_NOMBRE AS LOCAL_NOMBRE,
		BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_USUARIO(p.USUARIO_DNI) AS RANGO_ETARIO_USUARIO,
		BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_REPARTIDOR(e.REPARTIDOR_DNI) AS RANGO_ETARIO_REPARTIDOR,
		BI_PEDIDOS_APP.FX_CALCULAR_ESTADO(p.PEDIDO_ESTADO) AS PEDIDO_ESTADO,
		DATENAME(WEEKDAY, p.PEDIDO_FECHA) AS ID_DIA,
        BI_PEDIDOS_APP.FX_CALCULAR_RANGO_HORARIO(DATEPART(HOUR, p.PEDIDO_FECHA)) AS ID_RANGO_HORARIO,
        dl.LOCALIDAD_COD AS LOCALIDAD,
        l.LOCAL_CATEGORIA AS CATEGORIA_LOCAL,
		t.ID_TIEMPO AS ID_TIEMPO,
		p.PEDIDO_FECHA AS PEDIDO_FECHA,
		p.PEDIDO_FECHA_ENTREGA AS PEDIDO_FECHA_ENTREGA,
		e.ENVIO_PRECIO AS VALOR_ENVIO,
		r.TIPO_MOVILIDAD_COD,
		p.PEDIDO_CALIFICACION
        FROM PEDIDOS_APP.PEDIDO p
		join PEDIDOS_APP.LOCAL l on p.LOCAL_NOMBRE=l.LOCAL_NOMBRE
		join PEDIDOS_APP.DIRECCION_LOCAL dl on  l.LOCAL_NOMBRE = dl.LOCAL_NOMBRE
		join BI_PEDIDOS_APP.BI_TIEMPO t on DATEPART(month,p.PEDIDO_FECHA)=t.TIEMPO_MES and DATEPART(YEAR,p.PEDIDO_FECHA) = t.TIEMPO_ANIO
		join PEDIDOS_APP.ENVIO e on e.PEDIDO_NRO = p.PEDIDO_NRO
		join PEDIDOS_APP.REPARTIDOR r on e.REPARTIDOR_DNI = r.REPARTIDOR_DNI
END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_HECHO_ENVIO_MENSAJERIA
AS
	BEGIN 
		INSERT INTO BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA(
			ENVIO_MENSAJERIA_ENTREGA,
			ENVIO_MENSAJERIA_FECHA,
			LOCALIDAD_ID,
			ENVIO_MENSAJERIA_PRECIO_SEGURO,
			ENVIO_MENSAJERIA_VALOR_ASEGURADO,
			ENVIO_MENSAJERIA_TIEMPO_ESTIMADO,
			ID_DIA,
			ID_ESTADO_MENSAJERIA,
			ID_RANGO_HORARIO,
			ID_TIEMPO,
			RANGO_ETARIO_REPARTIDOR,
			RANGO_ETARIO_USUARIO,
			PAQUETE_NRO,
			TIPO_MOVILIDAD_ID
		) 
		SELECT 
			e.ENVIO_MENSAJERIA_ENTREGA,
			e.ENVIO_MENSAJERIA_FECHA,
			l.LOCALIDAD_ID,
			e.ENVIO_MENSAJERIA_PRECIO_SEGURO,
			e.ENVIO_MENSAJERIA_VALOR_ASEGURADO,
			e.ENVIO_MENSAJERIA_TIEMPO_ESTIMADO,
			d.ID_DIA,
			es.ESTADO_ENVIO_MENSAJERIA_ID,
			BI_PEDIDOS_APP.FX_CALCULAR_RANGO_HORARIO(DATEPART(HOUR, e.ENVIO_MENSAJERIA_FECHA)),
			t.ID_TIEMPO,
			BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_REPARTIDOR(e.REPARTIDOR_DNI),
			BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_USUARIO(e.USUARIO_DNI),
			tp.PAQUETE_ID,
			r.TIPO_MOVILIDAD_COD
			FROM PEDIDOS_APP.ENVIO_MENSAJERIA e
			JOIN BI_PEDIDOS_APP.BI_ESTADO_ENVIO_MENSAJERIA es on es.ENVIO_MENSAJERIA_ESTADO = e.ENVIO_MENSAJERIA_ESTADO
			JOIN BI_PEDIDOS_APP.BI_TIEMPO t ON t.TIEMPO_ANIO = DATEPART(YEAR, e.ENVIO_MENSAJERIA_FECHA) and t.TIEMPO_MES = DATEPART(MONTH, e.ENVIO_MENSAJERIA_FECHA) 
			JOIN BI_PEDIDOS_APP.BI_LOCALIDAD l on l.LOCALIDAD_NOMBRE = e.ENVIO_MENSAJERIA_LOCALIDAD 
			JOIN BI_PEDIDOS_APP.BI_DIA d on d.ID_DIA = DATENAME(WEEKDAY, e.ENVIO_MENSAJERIA_FECHA)
			JOIN PEDIDOS_APP.PAQUETE p on p.PAQUETE_NRO = e.PAQUETE_NRO
			JOIN BI_PEDIDOS_APP.BI_TIPO_PAQUETE tp on tp.PAQUETE_TIPO = p.PAQUETE_TIPO
			join PEDIDOS_APP.REPARTIDOR r on e.REPARTIDOR_DNI = r.REPARTIDOR_DNI
	END
GO

CREATE PROCEDURE BI_PEDIDOS_APP.MIGRAR_BI_HECHO_RECLAMO
AS
BEGIN
    INSERT INTO BI_PEDIDOS_APP.BI_HECHO_RECLAMO( 
	NRO_RECLAMO,
    RECLAMO_MONTO_CUPON_ASOCIADO,
	RECLAMO_FECHA,
	RECLAMO_FECHA_SOLUCION,
	ESTADO_RECLAMO,
	RANGO_ETARIO_OPERADOR_ID ,
	RANGO_HORARIO_ID,
	ID_TIEMPO,
	ID_DIA,
	TIPO_RECLAMO 
		)
        SELECT DISTINCT
		r.RECLAMO_NRO,
		c.CUPON_RECLAMO_MONTO,
		r.RECLAMO_FECHA,
		r.RECLAMO_FECHA_SOLUCION,
		BI_PEDIDOS_APP.FX_CALCULAR_ESTADO(r.RECLAMO_ESTADO) AS ESTADO_RECLAMO,
		BI_PEDIDOS_APP.FX_CALCULAR_RANGO_ETARIO_OPERADOR(op.OPERADOR_DNI) AS RANGO_ETARIO_OPERADOR_ID,
		BI_PEDIDOS_APP.FX_CALCULAR_RANGO_HORARIO(DATEPART(HOUR, r.RECLAMO_FECHA)),
		t.ID_TIEMPO,
		d.ID_DIA,
		r.RECLAMO_TIPO
		FROM PEDIDOS_APP.RECLAMO r
		join PEDIDOS_APP.RECLAMO_X_OPERADOR rxp on rxp.RECLAMO_NRO = r.RECLAMO_NRO
		join PEDIDOS_APP.OPERADOR op on rxp.OPERADOR_CODIGO = op.OPERADOR_CODIGO
		join BI_PEDIDOS_APP.BI_TIEMPO t on DATEPART(month, r.RECLAMO_FECHA) = t.TIEMPO_MES and DATEPART(YEAR,r.RECLAMO_FECHA) = t.TIEMPO_ANIO
		join BI_PEDIDOS_APP.BI_DIA d on datename(WEEKDAY, r.RECLAMO_FECHA) = d.ID_DIA
		join PEDIDOS_APP.CUPON_RECLAMO c on r.RECLAMO_NRO = c.RECLAMO_NRO
		WHERE r.RECLAMO_NRO is not null	
END
GO

/*EXECS*/
EXEC BI_PEDIDOS_APP.MIGRAR_BI_TIEMPO
EXEC BI_PEDIDOS_APP.MIGRAR_BI_DIA
EXEC BI_PEDIDOS_APP.MIGRAR_BI_RANGO_HORARIO
EXEC BI_PEDIDOS_APP.MIGRAR_BI_PROVINCIA
EXEC BI_PEDIDOS_APP.MIGRAR_BI_LOCALIDAD
EXEC BI_PEDIDOS_APP.MIGRAR_BI_RANGO_ETARIO
EXEC BI_PEDIDOS_APP.MIGRAR_BI_TIPO_MEDIO_DE_PAGO
EXEC BI_PEDIDOS_APP.MIGRAR_BI_LOCAL
EXEC BI_PEDIDOS_APP.MIGRAR_BI_TIPO_LOCAL
EXEC BI_PEDIDOS_APP.MIGRAR_BI_CATEGORIA_LOCAL
EXEC BI_PEDIDOS_APP.MIGRAR_BI_TIPO_MOVILIDAD
EXEC BI_PEDIDOS_APP.MIGRAR_BI_TIPO_PAQUETE
EXEC BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_PEDIDOS
EXEC BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_ENVIO_MENSAJERIA
EXEC BI_PEDIDOS_APP.MIGRAR_BI_ESTADO_RECLAMO
EXEC BI_PEDIDOS_APP.MIGRAR_BI_HECHO_PEDIDO
EXEC BI_PEDIDOS_APP.MIGRAR_BI_HECHO_ENVIO_MENSAJERIA
EXEC BI_PEDIDOS_APP.MIGRAR_BI_HECHO_RECLAMO
GO

/********************
    EJERCICIO 01
*********************/

CREATE VIEW BI_PEDIDOS_APP.VISTA_CANTIDAD_PEDIDOS_MES_ANIO_SEGUN_LOCALIDAD
AS	
SELECT *
	FROM(
	SELECT 
		l.LOCALIDAD_NOMBRE as Localidad,
		rh.RANGO_HORARIO_DESCRIPCION,
		d.DIA_LETRA,
		t.TIEMPO_MES as Mes,
		t.TIEMPO_ANIO as Anio,
		p.CATEGORIA_LOCAL,
		COUNT(*) as totalPedidos,
		RANK() OVER (PARTITION BY t.TIEMPO_ANIO, t.TIEMPO_MES, l.LOCALIDAD_NOMBRE ORDER BY COUNT(*) DESC) as RowNum
	FROM BI_PEDIDOS_APP.BI_HECHO_PEDIDO p
	JOIN BI_PEDIDOS_APP.BI_LOCALIDAD l on l.LOCALIDAD_ID = p.LOCALIDAD_ID
	JOIN BI_PEDIDOS_APP.BI_TIEMPO t ON p.ID_TIEMPO = t.ID_TIEMPO
    JOIN BI_PEDIDOS_APP.BI_DIA d ON p.ID_DIA = d.ID_DIA
    JOIN BI_PEDIDOS_APP.BI_RANGO_HORARIO rh ON p.ID_RANGO_HORARIO = rh.ID_RANGO_HORARIO
	GROUP BY l.LOCALIDAD_NOMBRE, rh.RANGO_HORARIO_DESCRIPCION, d.DIA_LETRA, t.TIEMPO_MES, t.TIEMPO_ANIO, p.CATEGORIA_LOCAL
	) AS Subquery
	WHERE RowNum = 1
GO

/*******************************
EJERCICIO 2
*******************************/


CREATE VIEW BI_PEDIDOS_APP.VISTA_MONTO_TOTAL_NO_COBRADO
AS
	SELECT
		p.LOCAL_NOMBRE,
		SUM(p.PEDIDO_TOTAL_SERVICIO) - SUM(p.PEDIDO_TOTAL_CUPONES) as MontoTotal,
		d.DIA_LETRA,
		r.RANGO_HORARIO_DESCRIPCION,
		e.PEDIDO_ESTADO as ESTADO
	FROM BI_PEDIDOS_APP.BI_HECHO_PEDIDO p
	JOIN BI_PEDIDOS_APP.BI_RANGO_HORARIO r on r.ID_RANGO_HORARIO = p.ID_RANGO_HORARIO
	JOIN BI_PEDIDOS_APP.BI_DIA d on d.ID_DIA = p.ID_DIA
	JOIN BI_PEDIDOS_APP.BI_ESTADO_PEDIDO e on e.ESTADO_PEDIDO_ID = p.PEDIDO_ESTADO
	WHERE e.ESTADO_PEDIDO_ID = 2
	GROUP BY p.LOCAL_NOMBRE, d.DIA_LETRA, R.RANGO_HORARIO_DESCRIPCION, e.PEDIDO_ESTADO
GO

/*******************************
EJERCICIO 3
*******************************/

CREATE VIEW BI_PEDIDOS_APP.VISTA_MONTO_ENVIO_PROMEDIO_MENSUAL
AS
	SELECT
		l.LOCALIDAD_NOMBRE,
		AVG(p.VALOR_ENVIO) as PROMEDIO_MENSUAL,
		t.TIEMPO_MES as Mes,
		t.TIEMPO_ANIO as Anio
	FROM BI_PEDIDOS_APP.BI_HECHO_PEDIDO p
	join BI_PEDIDOS_APP.BI_LOCALIDAD l on l.LOCALIDAD_ID = p.LOCALIDAD_ID
	join BI_PEDIDOS_APP.BI_TIEMPO t on t.ID_TIEMPO = p.ID_TIEMPO
	GROUP BY l.LOCALIDAD_NOMBRE, t.TIEMPO_ANIO, t.TIEMPO_MES
GO

/*******************************
EJERCICIO 4
*******************************/

CREATE VIEW BI_PEDIDOS_APP.VISTA_DESVIO_PROMEDIO_DE_ENTREGA
AS
	
SELECT 
    RANGO_HORARIO_DESCRIPCION,
    TIPO_MOVILIDAD_VEHICULO,
    DIA_LETRA,
    AVG(desvio) as promedio_desvio
FROM (
    SELECT 
        rh.RANGO_HORARIO_DESCRIPCION, 
        tp.TIPO_MOVILIDAD_VEHICULO,
        d.DIA_LETRA,
        DATEDIFF(MINUTE, PEDIDO_FECHA, PEDIDO_FECHA_ENTREGA) as desvio
    FROM BI_PEDIDOS_APP.BI_HECHO_PEDIDO hp
    join BI_PEDIDOS_APP.BI_DIA d ON d.ID_DIA = hp.ID_DIA
	join BI_PEDIDOS_APP.BI_TIPO_MOVILIDAD tp ON tp.TIPO_MOVILIDAD_ID = hp.TIPO_MOVILIDAD_ID
	join BI_PEDIDOS_APP.BI_RANGO_HORARIO rh ON rh.ID_RANGO_HORARIO = hp.ID_RANGO_HORARIO

    UNION ALL
    
    SELECT 
        rh.RANGO_HORARIO_DESCRIPCION, 
        tp.TIPO_MOVILIDAD_VEHICULO,
        d.DIA_LETRA,
        DATEDIFF(MINUTE, ENVIO_MENSAJERIA_FECHA, ENVIO_MENSAJERIA_ENTREGA) as desvio
	FROM BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA em
	  join BI_PEDIDOS_APP.BI_DIA d ON d.ID_DIA = em.ID_DIA
	join BI_PEDIDOS_APP.BI_TIPO_MOVILIDAD tp ON tp.TIPO_MOVILIDAD_ID = em.TIPO_MOVILIDAD_ID
	join BI_PEDIDOS_APP.BI_RANGO_HORARIO rh ON rh.ID_RANGO_HORARIO = em.ID_RANGO_HORARIO
) AS Subquery
GROUP BY RANGO_HORARIO_DESCRIPCION, TIPO_MOVILIDAD_VEHICULO, DIA_LETRA

GO


/*******************************
EJERCICIO 5
*******************************/

CREATE VIEW BI_PEDIDOS_APP.VISTA_MONTO_CUPONES_POR_RANGO_ETARIO_USUARIO
AS
		SELECT
			re.RANGO_ETARIO_DESCRIPCION,
			SUM(hp.PEDIDO_TOTAL_CUPONES) as MONTO_MENSUAL_CUPONES,
			t.TIEMPO_MES,
			t.TIEMPO_ANIO
		FROM BI_PEDIDOS_APP.BI_HECHO_PEDIDO hp
		join BI_PEDIDOS_APP.BI_RANGO_ETARIO re on re.RANGO_ETARIO_ID = hp.RANGO_ETARIO_USUARIO
		join BI_PEDIDOS_APP.BI_TIEMPO t on t.ID_TIEMPO = hp.ID_TIEMPO
	GROUP BY RANGO_ETARIO_DESCRIPCION, TIEMPO_ANIO, TIEMPO_MES
GO

/*******************************
EJERCICIO 6
*******************************/

CREATE VIEW BI_PEDIDOS_APP.VISTA_PROMEDIO_CALIFICACION_MENSUAL
AS
		SELECT
			hp.LOCAL_NOMBRE,
			AVG(hp.PEDIDO_CALIFICACION) as CALIFICACION_PROMEDIO,
			t.TIEMPO_MES,
			t.TIEMPO_ANIO --- pide la mensual pero no dice que por año asi que capaz este lo borramos
		FROM BI_PEDIDOS_APP.BI_HECHO_PEDIDO hp
		join BI_PEDIDOS_APP.BI_TIEMPO t on t.ID_TIEMPO = hp.ID_TIEMPO
	GROUP BY hp.LOCAL_NOMBRE, TIEMPO_ANIO, TIEMPO_MES
GO

/*******************************
EJERCICIO 7
*******************************
CREATE VIEW BI_PEDIDOS_APP.VISTA_PORCETAJE_PEDIDOS_Y_ENVIOS_MENSUALES_POR_LOCALIDAD
AS
	SELECT 
		RANGO_ETARIO_REPARTIDOR,
		LOCALIDAD_NOMBRE,
		TIEMPO_MES,
		sum(totalMes) as TotalVerdadero,
		sum(cantidad) * 100.0 / 
		sum(totalMes)
FROM (
		SELECT
			hp.RANGO_ETARIO_REPARTIDOR,
			l.LOCALIDAD_NOMBRE,
			t.TIEMPO_MES,
			count(*) over (PARTITION BY  t.TIEMPO_MES) as totalMes,
			COUNT(hp.LOCALIDAD_ID) as cantidad
		FROM BI_PEDIDOS_APP.BI_HECHO_PEDIDO hp
		join BI_PEDIDOS_APP.BI_TIEMPO t on t.ID_TIEMPO = hp.ID_TIEMPO
		JOIN BI_PEDIDOS_APP.BI_LOCALIDAD l on l.LOCALIDAD_ID = hp.LOCALIDAD_ID)as Subquery
		
		UNION ALL

		SELECT
			em.RANGO_ETARIO_REPARTIDOR,
			l.LOCALIDAD_NOMBRE,
			t.TIEMPO_MES,
			count(*) over (PARTITION BY  t.TIEMPO_MES) as totalMes,
			COUNT(em.LOCALIDAD_ID) as cantidad	
			FROM BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA em
		join BI_PEDIDOS_APP.BI_TIEMPO t on t.ID_TIEMPO = em.ID_TIEMPO
		JOIN BI_PEDIDOS_APP.BI_LOCALIDAD l on l.LOCALIDAD_ID = em.LOCALIDAD_ID

)AS Subquery
	GROUP BY LOCALIDAD_NOMBRE, RANGO_ETARIO_REPARTIDOR, TIEMPO_MES;
GO
*/

/*******************************
EJERCICIO 8
*******************************/

CREATE VIEW BI_PEDIDOS_APP.VISTA_PROMEDIO_MENSUAL_VALOR_ASEGURADO
AS
	SELECT
			tp.PAQUETE_TIPO,
			AVG(em.ENVIO_MENSAJERIA_VALOR_ASEGURADO) as PROMEDIO_VALOR_ASEUGRADO,
			t.TIEMPO_MES
		FROM BI_PEDIDOS_APP.BI_HECHO_ENVIO_MENSAJERIA em
		join BI_PEDIDOS_APP.BI_TIPO_PAQUETE tp on tp.PAQUETE_ID = em.PAQUETE_NRO
		join BI_PEDIDOS_APP.BI_TIEMPO t on t.ID_TIEMPO = em.ID_TIEMPO
	GROUP BY tp.PAQUETE_TIPO, TIEMPO_MES
GO

/*******************************
EJERCICIO 9
*******************************/

/*Falta agregarle el local*/

CREATE VIEW BI_PEDIDOS_APP.VISTA_PROMEDIO_MENSUAL_RECLAMOS_POR_LOCAL
AS
	SELECT
			t.TIEMPO_MES,
			d.DIA_LETRA,
			rh.RANGO_HORARIO_DESCRIPCION,
			count(*) AS cantidad_de_reclamos
		FROM BI_PEDIDOS_APP.BI_HECHO_RECLAMO r
		join BI_PEDIDOS_APP.BI_DIA d on d.ID_DIA = r.ID_DIA
		join BI_PEDIDOS_APP.BI_TIEMPO t on t.ID_TIEMPO = r.ID_TIEMPO
		join BI_PEDIDOS_APP.BI_RANGO_HORARIO rh on rh.ID_RANGO_HORARIO = r.RANGO_HORARIO_ID
	GROUP BY t.TIEMPO_MES,d.DIA_LETRA,rh.RANGO_HORARIO_DESCRIPCION
GO

/*******************************
EJERCICIO 9
*******************************/

CREATE VIEW BI_PEDIDOS_APP.VISTA_TIEMPO_PROMEDIO_RECLAMOS_MENSUAL
AS
	SELECT
		r.TIPO_RECLAMO,
		re.RANGO_ETARIO_DESCRIPCION,
		AVG(DATEDIFF(MINUTE,r.RECLAMO_FECHA, r.RECLAMO_FECHA_SOLUCION)) AS TIEMPO_PROMEDIO_RESOLUCION
	FROM BI_PEDIDOS_APP.BI_HECHO_RECLAMO r
	JOIN BI_PEDIDOS_APP.BI_ESTADO_RECLAMO e on e.ESTADO_RECLAMO_ID = r.ESTADO_RECLAMO
	JOIN BI_PEDIDOS_APP.BI_RANGO_ETARIO re on r.RANGO_ETARIO_OPERADOR_ID = re.RANGO_ETARIO_ID
	GROUP BY r.TIPO_RECLAMO, re.RANGO_ETARIO_DESCRIPCION
GO


/*******************************
EJERCICIO 10
*******************************/

CREATE VIEW BI_PEDIDOS_APP.VISTA_MONTO_MENSUAL_A_PARTIR_DE_CUPONES_RECLAMO
AS
	SELECT
		SUM(r.RECLAMO_MONTO_CUPON_ASOCIADO) as MONTO_MENSUAL_CUPONES,
		t.TIEMPO_ANIO,
		t.TIEMPO_MES
	FROM BI_PEDIDOS_APP.BI_HECHO_RECLAMO r
	JOIN BI_PEDIDOS_APP.BI_TIEMPO t on t.TIEMPO_ANIO = DATENAME(YEAR, r.RECLAMO_FECHA) and t.TIEMPO_MES = DATENAME(MONTH, r.RECLAMO_FECHA)
	GROUP BY t.TIEMPO_ANIO, t.TIEMPO_MES
GO



SELECT * FROM BI_PEDIDOS_APP.VISTA_CANTIDAD_PEDIDOS_MES_ANIO_SEGUN_LOCALIDAD
SELECT * FROM BI_PEDIDOS_APP.VISTA_MONTO_TOTAL_NO_COBRADO
SELECT * FROM BI_PEDIDOS_APP.VISTA_MONTO_ENVIO_PROMEDIO_MENSUAL
SELECT * FROM BI_PEDIDOS_APP.VISTA_DESVIO_PROMEDIO_DE_ENTREGA
SELECT * FROM BI_PEDIDOS_APP.VISTA_MONTO_CUPONES_POR_RANGO_ETARIO_USUARIO
SELECT * FROM BI_PEDIDOS_APP.VISTA_PROMEDIO_CALIFICACION_MENSUAL
--SELECT * FROM BI_PEDIDOS_APP.VISTA_PORCETAJE_PEDIDOS_Y_ENVIOS_MENSUALES_POR_LOCALIDAD
SELECT * FROM BI_PEDIDOS_APP.VISTA_PROMEDIO_MENSUAL_VALOR_ASEGURADO
SELECT * FROM BI_PEDIDOS_APP.VISTA_PROMEDIO_MENSUAL_RECLAMOS_POR_LOCAL
